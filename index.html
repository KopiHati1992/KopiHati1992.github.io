<!DOCTYPE html>
<html>
<head>
  <title>Dashboard Customer & Juli</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://apis.google.com/js/api.js"></script>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <style>
    :root {
      --primary: #4361ee;
      --primary-light: #4895ef;
      --secondary: #3f37c9;
      --dark: #1b263b;
      --light: #f8f9fa;
      --success: #4cc9f0;
      --danger: #f72585;
      --warning: #f8961e;
      --info: #560bad;
      --border-radius: 8px;
      --box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      --transition: all 0.3s ease;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Poppins', sans-serif;
      background-color: #f5f7ff;
      color: var(--dark);
      line-height: 1.6;
      padding: 0;
      margin: 0;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    
    header {
      background-color: white;
      box-shadow: var(--box-shadow);
      padding: 20px 0;
      margin-bottom: 30px;
    }
    
    .header-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    h2 {
      color: var(--primary);
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .btn {
      padding: 10px 20px;
      border-radius: var(--border-radius);
      border: none;
      font-weight: 500;
      cursor: pointer;
      transition: var(--transition);
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    
    .btn-primary {
      background-color: var(--primary);
      color: white;
    }
    
    .btn-primary:hover {
      background-color: var(--secondary);
      transform: translateY(-2px);
    }
    
    .btn-add {
      background-color: var(--success);
      color: white;
    }
    
    .btn-add:hover {
      background-color: #3aa8d8;
    }
    
    .btn-edit {
      background-color: var(--warning);
      color: white;
    }
    
    .btn-delete {
      background-color: var(--danger);
      color: white;
    }
    
    .btn-cancel {
      background-color: #6c757d;
      color: white;
    }
    
    .card {
      background-color: white;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      padding: 25px;
      margin-bottom: 30px;
    }
    
    .card-title {
      font-size: 18px;
      margin-bottom: 20px;
      color: var(--primary);
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    
    th, td {
      padding: 12px 15px;
      text-align: left;
      border-bottom: 1px solid #e0e0e0;
    }
    
    th {
      background-color: var(--primary);
      color: white;
      font-weight: 500;
    }
    
    tr:hover {
      background-color: #f8f9fa;
    }
    
    .action-buttons {
      display: flex;
      gap: 5px;
    }
    
    .form-group {
      margin-bottom: 15px;
    }
    
    .form-row {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 15px;
    }
    
    label {
      display: block;
      margin-bottom: 5px;
      font-weight: 500;
      color: var(--dark);
    }
    
    input, select, textarea {
      width: 100%;
      padding: 10px 15px;
      border: 1px solid #ddd;
      border-radius: var(--border-radius);
      font-family: 'Poppins', sans-serif;
      transition: var(--transition);
    }
    
    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 2px rgba(67, 97, 238, 0.2);
    }
    
    .btn-submit {
      background-color: var(--success);
      color: white;
      padding: 12px 25px;
      margin-top: 10px;
    }
    
    .btn-submit:hover {
      background-color: #3aa8d8;
    }
    
    .alert {
      padding: 15px;
      border-radius: var(--border-radius);
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .alert-success {
      background-color: #d1fae5;
      color: #065f46;
    }
    
    .alert-danger {
      background-color: #fee2e2;
      color: #b91c1c;
    }
    
    .alert-info {
      background-color: #dbeafe;
      color: #1e40af;
    }
    
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }
    
    .modal-content {
      background-color: white;
      padding: 30px;
      border-radius: var(--border-radius);
      width: 90%;
      max-width: 600px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    
    .modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-top: 20px;
    }
    
    .table-responsive {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }
    
    .btn-text {
      display: inline;
    }
    
    .tab-container {
      display: flex;
      margin-bottom: 20px;
      border-bottom: 1px solid #ddd;
    }
    
    .tab {
      padding: 10px 20px;
      cursor: pointer;
      border: 1px solid transparent;
      border-bottom: none;
      border-radius: 5px 5px 0 0;
      margin-right: 5px;
      background-color: #f1f1f1;
    }
    
    .tab.active {
      background-color: white;
      border-color: #ddd;
      border-bottom: 1px solid white;
      margin-bottom: -1px;
      font-weight: 500;
      color: var(--primary);
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
    
    .status-paid {
      background-color: #d1fae5;
      color: #065f46;
      padding: 5px 10px;
      border-radius: 20px;
      font-size: 0.8rem;
      display: inline-block;
    }
    
    .status-unpaid {
      background-color: #fee2e2;
      color: #b91c1c;
      padding: 5px 10px;
      border-radius: 20px;
      font-size: 0.8rem;
      display: inline-block;
    }
    
    .status-pending {
      background-color: #fef3c7;
      color: #92400e;
      padding: 5px 10px;
      border-radius: 20px;
      font-size: 0.8rem;
      display: inline-block;
    }
    
    .customer-field, .juli-field {
      transition: all 0.3s ease;
    }
    
    #edit-status {
      width: 100%;
      padding: 10px 15px;
      border: 1px solid #ddd;
      border-radius: var(--border-radius);
      font-family: 'Poppins', sans-serif;
    }
    
    /* Responsive Styles */
    @media (max-width: 768px) {
      table {
        display: block;
        overflow-x: auto;
        white-space: nowrap;
      }
      
      .modal-content {
        width: 95%;
        padding: 15px;
      }
      
      .form-row {
        grid-template-columns: 1fr;
      }
      
      .action-buttons {
        flex-direction: column;
        gap: 5px;
      }
      
      .action-buttons .btn {
        width: 100%;
        justify-content: center;
      }
      
      th, td {
        padding: 8px 10px;
        font-size: 14px;
      }
      
      .header-content {
        flex-direction: column;
        gap: 15px;
        align-items: flex-start;
      }
    }
    
    @media (max-width: 600px) {
      .btn-text {
        display: none;
      }
      
      .btn i {
        margin-right: 0;
      }
      
      .form-group {
        margin-bottom: 10px;
      }
      
      .card {
        margin-bottom: 15px;
        padding: 15px;
      }
      
      .btn {
        padding: 8px 12px;
        font-size: 14px;
      }
      
      input, select, textarea {
        padding: 8px 12px;
      }
    }
    
    /* Date input styling */
    input[type="date"] {
      position: relative;
    }
    
    input[type="date"]::-webkit-calendar-picker-indicator {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      width: auto;
      height: auto;
      color: transparent;
      background: transparent;
    }
    
    input[type="date"]::-webkit-inner-spin-button,
    input[type="date"]::-webkit-clear-button {
      display: none;
    }
  </style>
</head>
<body>
  <header>
    <div class="container header-content">
      <h2><i class="fas fa-users"></i> Dashboard Customer & Juli</h2>
      <button class="btn btn-primary" onclick="handleAuthClick()">
        <i class="fab fa-google"></i> <span class="btn-text">Login dengan Google</span>
      </button>
    </div>
  </header>

  <main class="container">
    <div class="tab-container">
      <div class="tab active" onclick="switchTab('customer')">Data Customer</div>
      <div class="tab" onclick="switchTab('juli')">Data Juli</div>
    </div>
    
    <!-- Tab Customer -->
    <div id="customer-tab" class="tab-content active">
      <div class="card">
        <div class="header-content">
          <h3 class="card-title"><i class="fas fa-list"></i> Daftar Customer</h3>
          <button class="btn btn-add" onclick="toggleAddForm('customer')">
            <i class="fas fa-plus"></i> <span class="btn-text">Tambah Customer</span>
          </button>
        </div>
        
        <div id="customer-form-tambah-container" class="form-tambah-container">
          <!-- Form tambah customer akan di-render secara dinamis -->
        </div>
        
        <div id="customer-content"></div>
      </div>
    </div>
    
    <!-- Tab Juli -->
    <div id="juli-tab" class="tab-content">
      <div class="card">
        <div class="header-content">
          <h3 class="card-title"><i class="fas fa-calendar-alt"></i> Daftar Tagihan Juli</h3>
          <button class="btn btn-add" onclick="toggleAddForm('juli')">
            <i class="fas fa-plus"></i> <span class="btn-text">Tambah Data</span>
          </button>
        </div>
        
        <div id="juli-form-tambah-container" class="form-tambah-container">
          <!-- Form tambah Juli akan di-render secara dinamis -->
        </div>
        
        <div id="juli-content"></div>
      </div>
    </div>
  </main>

  <!-- Modal Edit -->
  <div id="editModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="edit-modal-title"><i class="fas fa-edit"></i> Edit Data</h3>
        <button onclick="closeModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;">&times;</button>
      </div>
      <form id="form-edit">
        <input type="hidden" id="edit-sheet">
        <input type="hidden" id="edit-row">
        
        <div class="form-row">
          <div class="form-group">
            <label for="edit-no">No</label>
            <input type="text" id="edit-no" required readonly>
          </div>
          <div class="form-group">
            <label for="edit-cust">Customer</label>
            <input type="text" id="edit-cust" required>
          </div>
          
          <!-- Customer-specific fields -->
          <div class="form-group customer-field">
            <label for="edit-wa">WhatsApp</label>
            <input type="text" id="edit-wa">
          </div>
          <div class="form-group customer-field">
            <label for="edit-alamat">Alamat</label>
            <input type="text" id="edit-alamat">
          </div>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label for="edit-tagihan">Tagihan (Rp)</label>
            <input type="text" id="edit-tagihan" required 
                   oninput="formatCurrency(this)" pattern="[0-9.,]*">
          </div>
          <div class="form-group">
            <label for="edit-tempo">Jatuh Tempo</label>
            <input type="date" id="edit-tempo" required>
          </div>
          
          <!-- Customer-specific fields -->
          <div class="form-group customer-field">
            <label for="edit-ip">IP Internet</label>
            <input type="text" id="edit-ip">
          </div>
          
          <!-- Juli-specific field -->
          <div class="form-group juli-field" style="display: none;">
            <label for="edit-status">Status</label>
            <select id="edit-status">
              <option value="Lunas">Lunas</option>
              <option value="Belum Lunas">Belum Lunas</option>
              <option value="Pending">Pending</option>
            </select>
          </div>
          
          <!-- Customer-specific field -->
          <div class="form-group customer-field">
            <label for="edit-ket">Keterangan</label>
            <input type="text" id="edit-ket">
          </div>
        </div>
        
        <div class="modal-footer">
          <button type="button" class="btn btn-cancel" onclick="closeModal()">
            <i class="fas fa-times"></i> <span class="btn-text">Batal</span>
          </button>
          <button type="submit" class="btn btn-submit">
            <i class="fas fa-save"></i> <span class="btn-text">Simpan Perubahan</span>
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal Delete Confirmation -->
  <div id="deleteModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3><i class="fas fa-trash-alt"></i> Hapus Data</h3>
        <button onclick="closeModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;">&times;</button>
      </div>
      <p id="delete-message">Apakah Anda yakin ingin menghapus data ini?</p>
      <input type="hidden" id="delete-sheet">
      <input type="hidden" id="delete-row">
      <div class="modal-footer">
        <button type="button" class="btn btn-cancel" onclick="closeModal()">
          <i class="fas fa-times"></i> <span class="btn-text">Batal</span>
        </button>
        <button type="button" class="btn btn-delete" onclick="confirmDelete()">
          <i class="fas fa-trash-alt"></i> <span class="btn-text">Hapus</span>
        </button>
      </div>
    </div>
  </div>

  <script>
    const CLIENT_ID = '805721921065-idl1i4jonepi7odtr4f7eiv1h4mbamk2.apps.googleusercontent.com';
    const API_KEY = 'AIzaSyArISbb4W_mfRyZxJzi12Sm3eByi0jQCjM';
    const SPREADSHEET_ID = '1AQx4YgRW9R-epO8BGlyFvN7CKIGyKgxmE1LgGqNpbs4';
    const SCOPES = 'https://www.googleapis.com/auth/spreadsheets';

    const SHEETS_CONFIG = {
      customer: {
        name: 'DATA CUSTOMER',
        range: 'DATA CUSTOMER!A2:H',
        columns: ['No', 'Customer', 'WhatsApp', 'Alamat', 'Tagihan', 'Jatuh Tempo', 'IP Internet', 'Keterangan'],
        formFields: [
          { id: 'no', label: 'No', type: 'text', readonly: true },
          { id: 'cust', label: 'Customer', type: 'text', required: true },
          { id: 'wa', label: 'WhatsApp', type: 'text', required: true },
          { id: 'alamat', label: 'Alamat', type: 'text', required: true },
          { id: 'tagihan', label: 'Tagihan (Rp)', type: 'text', required: true, oninput: "formatCurrency(this)" },
          { id: 'tempo', label: 'Jatuh Tempo', type: 'date', required: true },
          { id: 'ip', label: 'IP Internet', type: 'text', required: true },
          { id: 'ket', label: 'Keterangan', type: 'text' }
        ]
      },
      juli: {
        name: 'JULI',
        range: 'JULI!A2:E',
        columns: ['No', 'Customer', 'Tagihan', 'Jatuh Tempo', 'Status'],
        formFields: [
          { id: 'no', label: 'No', type: 'text', readonly: true },
          { id: 'cust', label: 'Customer', type: 'text', required: true },
          { id: 'tagihan', label: 'Tagihan (Rp)', type: 'text', required: true, oninput: "formatCurrency(this)" },
          { id: 'tempo', label: 'Jatuh Tempo', type: 'date', required: true },
          { 
            id: 'status', 
            label: 'Status', 
            type: 'select', 
            required: true,
            options: [
              { value: '', text: 'Pilih Status' },
              { value: 'Lunas', text: 'Lunas' },
              { value: 'Belum Lunas', text: 'Belum Lunas' },
              { value: 'Pending', text: 'Pending' }
            ]
          }
        ]
      }
    };

    let tokenClient;
    let sheetData = {
      customer: [],
      juli: []
    };
    let lastNumbers = {
      customer: 0,
      juli: 0
    };
    let activeTab = 'customer';

    function handleClientLoad() {
      gapi.load('client', initClient);
    }

    async function initClient() {
      await gapi.client.init({
        apiKey: API_KEY,
        discoveryDocs: ["https://sheets.googleapis.com/$discovery/rest?version=v4"]
      });

      tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: CLIENT_ID,
        scope: SCOPES,
        callback: (tokenResponse) => {
          if (tokenResponse.error) {
            showAlert('Login gagal', 'danger');
            return;
          }
          loadAllSheetData();
        },
      });
    }

    function loadAllSheetData() {
      loadSheetData('customer');
      loadSheetData('juli');
    }

    async function loadSheetData(sheetKey) {
      const config = SHEETS_CONFIG[sheetKey];
      
      try {
        const response = await gapi.client.sheets.spreadsheets.values.get({
          spreadsheetId: SPREADSHEET_ID,
          range: config.range,
          valueRenderOption: 'UNFORMATTED_VALUE',
          dateTimeRenderOption: 'FORMATTED_STRING'
        });
        
        const data = response.result.values;
        sheetData[sheetKey] = data || [];
        
        // Update lastNumber
        lastNumbers[sheetKey] = getLastNumber(sheetData[sheetKey]);
        
        // Render data
        renderData(sheetKey);
        
      } catch (error) {
        console.error(`Error loading ${sheetKey} data:`, error);
        document.getElementById(`${sheetKey}-content`).innerHTML = `
          <div class="alert alert-danger">
            <i class="fas fa-exclamation-triangle"></i> Gagal mengambil data ${sheetKey}: ${error.result?.error?.message || 'Error tidak diketahui'}
          </div>
        `;
      }
    }

    function renderData(sheetKey) {
      const config = SHEETS_CONFIG[sheetKey];
      const data = sheetData[sheetKey];
      
      if (!data || data.length === 0) {
        document.getElementById(`${sheetKey}-content`).innerHTML = `
          <div class="alert alert-info">
            <i class="fas fa-info-circle"></i> Tidak ada data ditemukan.
          </div>
        `;
        return;
      }

      // Urutkan data berdasarkan tanggal jatuh tempo jika ada kolom tempo
      if (sheetKey === 'customer' || sheetKey === 'juli') {
        data.sort((a, b) => {
          const dateA = new Date(a[sheetKey === 'customer' ? 5 : 3]);
          const dateB = new Date(b[sheetKey === 'customer' ? 5 : 3]);
          return dateA - dateB;
        });
      }

      let html = '<div class="table-responsive"><table><thead><tr>';
      config.columns.forEach(header => {
        html += `<th>${header || ''}</th>`;
      });
      html += '<th>Aksi</th></tr></thead><tbody>';

      data.forEach((row, index) => {
        if (!row) return;
        
        html += '<tr>';
        const rowData = [...row];
        
        rowData.forEach((cell, colIndex) => {
          if (colIndex === (sheetKey === 'customer' ? 4 : 2) && cell !== '' && !isNaN(cell)) {
            html += `<td>Rp${parseInt(cell).toLocaleString('id-ID')}</td>`;
          } 
          else if (colIndex === (sheetKey === 'customer' ? 5 : 3)) {
            if (typeof cell === 'string') {
              html += `<td>${cell || ''}</td>`;
            } 
            else if (!isNaN(cell)) {
              const date = new Date((cell - 25568) * 86400 * 1000);
              const formattedDate = date.toISOString().split('T')[0];
              html += `<td>${formattedDate}</td>`;
            } else {
              html += `<td>${cell || ''}</td>`;
            }
          }
          else if (sheetKey === 'juli' && colIndex === 4) {
            html += `<td><span class="${getStatusClass(cell)}">${cell || ''}</span></td>`;
          }
          else {
            html += `<td>${cell || ''}</td>`;
          }
        });
        
        html += `
          <td class="action-buttons">
            <button class="btn btn-edit" onclick="openEditModal('${sheetKey}', ${index})">
              <i class="fas fa-edit"></i> <span class="btn-text">Edit</span>
            </button>
            <button class="btn btn-delete" onclick="openDeleteModal('${sheetKey}', ${index})">
              <i class="fas fa-trash-alt"></i> <span class="btn-text">Hapus</span>
            </button>
          </td>
        </tr>`;
      });

      html += '</tbody></table></div>';
      document.getElementById(`${sheetKey}-content`).innerHTML = html;
    }

    function switchTab(tabName) {
      activeTab = tabName;
      document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
      });
      document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
      });
      
      document.querySelector(`.tab[onclick="switchTab('${tabName}')"]`).classList.add('active');
      document.getElementById(`${tabName}-tab`).classList.add('active');
    }

    function getLastNumber(data) {
      if (!data || data.length === 0) return 0;
      
      let maxNumber = 0;
      data.forEach(row => {
        const num = parseInt(row[0]) || 0;
        if (num > maxNumber) maxNumber = num;
      });
      
      return maxNumber;
    }

    function formatCurrency(input) {
      const rawValue = input.value.replace(/\D/g, '');
      input.dataset.rawValue = rawValue;
      
      if (rawValue.length > 0) {
        input.value = parseInt(rawValue).toLocaleString('id-ID');
      } else {
        input.value = '';
      }
    }

    function getRawNumber(input) {
      return input.dataset.rawValue || input.value.replace(/\D/g, '') || '0';
    }

    function showAlert(message, type) {
      const alertDiv = document.createElement('div');
      alertDiv.className = `alert alert-${type}`;
      alertDiv.innerHTML = `
        <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i>
        ${message}
      `;
      
      const container = document.querySelector('.container');
      container.insertBefore(alertDiv, container.firstChild);
      
      setTimeout(() => {
        alertDiv.remove();
      }, 5000);
    }

    function toggleAddForm(sheetKey) {
      const formContainer = document.getElementById(`${sheetKey}-form-tambah-container`);
      
      if (formContainer.style.display === 'block') {
        formContainer.style.display = 'none';
      } else {
        formContainer.style.display = 'block';
        renderAddForm(sheetKey);
        // Set nomor otomatis saat form ditampilkan
        document.getElementById(`${sheetKey}-no`).value = lastNumbers[sheetKey] + 1;
      }
    }

    function renderAddForm(sheetKey) {
      const config = SHEETS_CONFIG[sheetKey];
      let formHTML = '<form id="form-tambah-' + sheetKey + '">';
      
      // Baris pertama form
      formHTML += '<div class="form-row">';
      config.formFields.slice(0, 2).forEach(field => {
        formHTML += renderFormField(sheetKey, field);
      });
      formHTML += '</div>';
      
      // Baris kedua form
      formHTML += '<div class="form-row">';
      config.formFields.slice(2).forEach(field => {
        formHTML += renderFormField(sheetKey, field);
      });
      formHTML += '</div>';
      
      // Footer form
      formHTML += `
        <div class="form-footer">
          <button type="button" class="btn btn-cancel" onclick="toggleAddForm('${sheetKey}')">
            <i class="fas fa-times"></i> <span class="btn-text">Batal</span>
          </button>
          <button type="submit" class="btn btn-submit">
            <i class="fas fa-save"></i> <span class="btn-text">Simpan Data</span>
          </button>
        </div>
      </form>`;
      
      const formContainer = document.getElementById(`${sheetKey}-form-tambah-container`);
      formContainer.innerHTML = formHTML;
      
      // Tambahkan event listener untuk form submit
      document.getElementById(`form-tambah-${sheetKey}`).addEventListener('submit', function(e) {
        e.preventDefault();
        saveData(sheetKey);
      });
    }

    function renderFormField(sheetKey, field) {
      let html = `<div class="form-group">
        <label for="${sheetKey}-${field.id}">${field.label}</label>`;
      
      if (field.type === 'select') {
        html += `<select id="${sheetKey}-${field.id}" ${field.required ? 'required' : ''}>`;
        field.options.forEach(option => {
          html += `<option value="${option.value}">${option.text}</option>`;
        });
        html += '</select>';
      } else {
        html += `<input type="${field.type}" id="${sheetKey}-${field.id}" 
               placeholder="${field.label}" ${field.required ? 'required' : ''} 
               ${field.readonly ? 'readonly' : ''}
               ${field.oninput ? `oninput="${field.oninput}"` : ''}>`;
      }
      
      html += '</div>';
      return html;
    }

    function saveData(sheetKey) {
      const config = SHEETS_CONFIG[sheetKey];
      const prefix = `${sheetKey}-`;
      
      // Auto-increment nomor
      lastNumbers[sheetKey]++;
      
      // Siapkan data sesuai dengan konfigurasi sheet
      const values = config.formFields.map(field => {
        const element = document.getElementById(prefix + field.id);
        
        if (field.id === 'tagihan') {
          return parseInt(getRawNumber(element)) || 0;
        }
        return element.value || '';
      });

      const body = { values: [values] };

      gapi.client.sheets.spreadsheets.values.append({
        spreadsheetId: SPREADSHEET_ID,
        range: `${config.name}!A1`,
        valueInputOption: 'USER_ENTERED',
        insertDataOption: 'INSERT_ROWS',
        resource: body
      }).then(() => {
        showAlert('Data berhasil ditambahkan!', 'success');
        loadSheetData(sheetKey);
        toggleAddForm(sheetKey);
        // Set nomor berikutnya
        lastNumbers[sheetKey] = getLastNumber(sheetData[sheetKey]);
      }, (error) => {
        showAlert('Gagal menambah data: ' + error.result.error.message, 'danger');
        // Rollback lastNumber jika gagal
        lastNumbers[sheetKey]--;
      });
    }

    function getStatusClass(status) {
      if (status === 'Lunas') return 'status-paid';
      if (status === 'Belum Lunas') return 'status-unpaid';
      if (status === 'Pending') return 'status-pending';
      return '';
    }

    function openEditModal(sheetKey, rowIndex) {
      const config = SHEETS_CONFIG[sheetKey];
      const rowData = sheetData[sheetKey][rowIndex];
      
      // Set modal title based on sheet
      document.getElementById('edit-modal-title').innerHTML = 
        `<i class="fas fa-edit"></i> Edit ${sheetKey === 'customer' ? 'Customer' : 'Tagihan Juli'}`;
      
      // Set sheet and row info
      document.getElementById('edit-sheet').value = sheetKey;
      document.getElementById('edit-row').value = rowIndex + 2;
      
      // Toggle field visibility
      document.querySelectorAll('.customer-field').forEach(el => {
        el.style.display = sheetKey === 'customer' ? 'block' : 'none';
      });
      document.querySelectorAll('.juli-field').forEach(el => {
        el.style.display = sheetKey === 'juli' ? 'block' : 'none';
      });
      
      // Fill form with data
      config.formFields.forEach((field, index) => {
        const element = document.getElementById('edit-' + field.id);
        if (element) {
          if (field.id === 'tagihan') {
            element.value = rowData[index] ? parseInt(rowData[index]).toLocaleString('id-ID') : '';
            element.dataset.rawValue = rowData[index] || '';
          } 
          else if (field.id === 'tempo') {
            if (rowData[index]) {
              const date = excelDateToJSDate(rowData[index]);
              element.value = date.toISOString().split('T')[0];
            }
          }
          else if (field.type === 'select') {
            element.value = rowData[index] || '';
          }
          else {
            element.value = rowData[index] || '';
          }
        }
      });
      
      document.getElementById('editModal').style.display = 'flex';
    }

    function openDeleteModal(sheetKey, rowIndex) {
      document.getElementById('delete-sheet').value = sheetKey;
      document.getElementById('delete-row').value = rowIndex + 2;
      document.getElementById('delete-message').textContent = 
        `Apakah Anda yakin ingin menghapus data ${sheetKey === 'customer' ? 'customer' : 'tagihan Juli'} ini?`;
      document.getElementById('deleteModal').style.display = 'flex';
    }

    function closeModal() {
      document.getElementById('editModal').style.display = 'none';
      document.getElementById('deleteModal').style.display = 'none';
    }

    document.getElementById('form-edit').addEventListener('submit', async function(e) {
      e.preventDefault();
      const sheetKey = document.getElementById('edit-sheet').value;
      const config = SHEETS_CONFIG[sheetKey];
      const rowNumber = document.getElementById('edit-row').value;
      
      try {
        const values = config.formFields.map(field => {
          const element = document.getElementById('edit-' + field.id);
          
          if (field.id === 'tagihan') {
            return parseInt(getRawNumber(element)) || 0;
          }
          return element.value || '';
        });

        const response = await gapi.client.sheets.spreadsheets.values.update({
          spreadsheetId: SPREADSHEET_ID,
          range: `${config.name}!A${rowNumber}:${String.fromCharCode(65 + config.formFields.length - 1)}${rowNumber}`,
          valueInputOption: 'USER_ENTERED',
          resource: { values: [values] }
        });
        
        showAlert('Data berhasil diperbarui!', 'success');
        closeModal();
        await loadSheetData(sheetKey);
      } catch (error) {
        console.error('Error updating data:', error);
        showAlert(`Gagal memperbarui data: ${error.result?.error?.message || 'Error tidak diketahui'}`, 'danger');
      }
    });

    async function confirmDelete() {
      const sheetKey = document.getElementById('delete-sheet').value;
      const rowNumber = document.getElementById('delete-row').value;
      const config = SHEETS_CONFIG[sheetKey];
      
      try {
        const sheetId = await getSheetIdByName(config.name);
        
        await gapi.client.sheets.spreadsheets.batchUpdate({
          spreadsheetId: SPREADSHEET_ID,
          resource: {
            requests: [{
              deleteDimension: {
                range: {
                  sheetId: sheetId,
                  dimension: "ROWS",
                  startIndex: rowNumber - 1,
                  endIndex: rowNumber
                }
              }
            }]
          }
        });
        
        showAlert('Data berhasil dihapus!', 'success');
        closeModal();
        await loadSheetData(sheetKey);
      } catch (error) {
        console.error('Error deleting data:', error);
        showAlert('Gagal menghapus data: ' + error.result?.error?.message, 'danger');
      }
    }

    async function getSheetIdByName(sheetName) {
      try {
        const response = await gapi.client.sheets.spreadsheets.get({
          spreadsheetId: SPREADSHEET_ID,
          fields: 'sheets.properties'
        });
        
        const sheet = response.result.sheets.find(s => 
          s.properties.title === sheetName
        );
        
        if (!sheet) {
          console.error(`Sheet ${sheetName} not found`);
          return 0; // Default fallback
        }
        
        return sheet.properties.sheetId;
      } catch (error) {
        console.error('Error getting sheet ID:', error);
        return 0; // Fallback value
      }
    }

    function excelDateToJSDate(serial) {
      try {
        if (typeof serial === 'string') return new Date(serial);
        
        const utcDays = Math.floor(serial - 25568);
        const utcValue = utcDays * 86400;
        const date = new Date(utcValue * 1000);
        
        if (serial < 60) {
          date.setFullYear(date.getFullYear() - 1);
        }
        
        return date;
      } catch (e) {
        console.error('Error converting Excel date:', serial, e);
        return new Date();
      }
    }

    function handleAuthClick() {
      tokenClient.requestAccessToken();
    }
    
    
<script>
function isiDataOtomatisJuli() {
  const selectedName = document.getElementById("juli-cust").value;
  const data = sheetData.customer.find(row => row[1] === selectedName);

  if (data) {
    const tagihanInput = document.getElementById("juli-tagihan");
    const tempoInput = document.getElementById("juli-tempo");

    tagihanInput.value = parseInt(data[4]).toLocaleString('id-ID');
    tagihanInput.dataset.rawValue = data[4];

    const date = excelDateToJSDate(data[5]);
    tempoInput.value = date.toISOString().split('T')[0];
  }
}

// Modifikasi renderFormField untuk dropdown customer (khusus sheetKey === 'juli')
const originalRenderFormField = renderFormField;
renderFormField = function(sheetKey, field) {
  if (sheetKey === 'juli' && field.id === 'cust') {
    let html = `<div class="form-group">
      <label for="${sheetKey}-${field.id}">${field.label}</label>
      <select id="${sheetKey}-${field.id}" required onchange="isiDataOtomatisJuli()">
        <option value="">Pilih Customer</option>`;
    sheetData.customer.forEach(row => {
      html += `<option value="${row[1]}">${row[1]}</option>`;
    });
    html += `</select></div>`;
    return html;
  }
  return originalRenderFormField(sheetKey, field);
};
</script>

window.onload = handleClientLoad;
  </script>
</body>
</html>

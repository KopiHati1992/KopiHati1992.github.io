<!DOCTYPE html>
<html>
<head>
  <title>Dashboard Customer</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://apis.google.com/js/api.js"></script>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <header>
    <div class="container header-content">
      <h2><i class="fas fa-users"></i> Dashboard Customer</h2>
      <button class="btn btn-primary" onclick="handleAuthClick()">
        <i class="fab fa-google"></i> Login dengan Google
      </button>
    </div>
  </header>

  <main class="container">
    <div class="card">
      <div id="content"></div>
    </div>

    <div class="card">
      <h3 class="card-title"><i class="fas fa-plus-circle"></i> Tambah Data Customer Baru</h3>
      <form id="form-tambah">
        <div class="form-row">
          <div class="form-group">
            <label for="no">No</label>
            <input type="text" id="no" placeholder="No" required>
          </div>
          <div class="form-group">
            <label for="cust">Customer</label>
            <input type="text" id="cust" placeholder="Nama Customer" required>
          </div>
          <div class="form-group">
            <label for="wa">WhatsApp</label>
            <input type="text" id="wa" placeholder="Nomor WhatsApp" required>
          </div>
          <div class="form-group">
            <label for="alamat">Alamat</label>
            <input type="text" id="alamat" placeholder="Alamat" required>
          </div>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label for="tagihan">Tagihan (Rp)</label>
            <input type="text" id="tagihan" placeholder="Contoh: 150000" required 
                   oninput="formatCurrency(this)" pattern="[0-9.,]*">
          </div>
          <div class="form-group">
            <label for="tempo">Jatuh Tempo</label>
            <input type="date" id="tempo" required>
          </div>
          <div class="form-group">
            <label for="ip">IP Internet</label>
            <input type="text" id="ip" placeholder="Alamat IP" required>
          </div>
          <div class="form-group">
            <label for="ket">Keterangan</label>
            <input type="text" id="ket" placeholder="Keterangan tambahan">
          </div>
        </div>
        
        <button type="submit" class="btn btn-submit">
          <i class="fas fa-save"></i> Simpan Data
        </button>
      </form>
    </div>
  </main>

  <!-- Modal Edit -->
  <div id="editModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3><i class="fas fa-edit"></i> Edit Customer</h3>
        <button onclick="closeModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;">&times;</button>
      </div>
      <form id="form-edit">
        <input type="hidden" id="edit-row">
        <div class="form-row">
          <div class="form-group">
            <label for="edit-no">No</label>
            <input type="text" id="edit-no" required>
          </div>
          <div class="form-group">
            <label for="edit-cust">Customer</label>
            <input type="text" id="edit-cust" required>
          </div>
          <div class="form-group">
            <label for="edit-wa">WhatsApp</label>
            <input type="text" id="edit-wa" required>
          </div>
          <div class="form-group">
            <label for="edit-alamat">Alamat</label>
            <input type="text" id="edit-alamat" required>
          </div>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label for="edit-tagihan">Tagihan (Rp)</label>
            <input type="text" id="edit-tagihan" required 
                   oninput="formatCurrency(this)" pattern="[0-9.,]*">
          </div>
          <div class="form-group">
            <label for="edit-tempo">Jatuh Tempo</label>
            <input type="date" id="edit-tempo" required>
          </div>
          <div class="form-group">
            <label for="edit-ip">IP Internet</label>
            <input type="text" id="edit-ip" required>
          </div>
          <div class="form-group">
            <label for="edit-ket">Keterangan</label>
            <input type="text" id="edit-ket">
          </div>
        </div>
        
        <div class="modal-footer">
          <button type="button" class="btn btn-cancel" onclick="closeModal()">
            <i class="fas fa-times"></i> Batal
          </button>
          <button type="submit" class="btn btn-submit">
            <i class="fas fa-save"></i> Simpan Perubahan
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal Delete Confirmation -->
  <div id="deleteModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3><i class="fas fa-trash-alt"></i> Hapus Customer</h3>
        <button onclick="closeModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;">&times;</button>
      </div>
      <p>Apakah Anda yakin ingin menghapus data customer ini?</p>
      <input type="hidden" id="delete-row">
      <div class="modal-footer">
        <button type="button" class="btn btn-cancel" onclick="closeModal()">
          <i class="fas fa-times"></i> Batal
        </button>
        <button type="button" class="btn btn-delete" onclick="confirmDelete()">
          <i class="fas fa-trash-alt"></i> Hapus
        </button>
      </div>
    </div>
  </div>

  <script>
    const CLIENT_ID = '805721921065-idl1i4jonepi7odtr4f7eiv1h4mbamk2.apps.googleusercontent.com';
    const API_KEY = 'AIzaSyArISbb4W_mfRyZxJzi12Sm3eByi0jQCjM';
    const SPREADSHEET_ID = '1AQx4YgRW9R-epO8BGlyFvN7CKIGyKgxmE1LgGqNpbs4';
    const SHEET_NAME = 'DATA CUSTOMER';
    const RANGE = `${SHEET_NAME}!A2:H`;
    const SCOPES = 'https://www.googleapis.com/auth/spreadsheets';

    let tokenClient;
    let sheetData = [];

    function handleClientLoad() {
      gapi.load('client', initClient);
    }

    async function initClient() {
      await gapi.client.init({
        apiKey: API_KEY,
        discoveryDocs: ["https://sheets.googleapis.com/$discovery/rest?version=v4"]
      });

      tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: CLIENT_ID,
        scope: SCOPES,
        callback: (tokenResponse) => {
          if (tokenResponse.error) {
            showAlert('Login gagal', 'danger');
            return;
          }
          loadSheetData();
        },
      });
    }

    function handleAuthClick() {
      tokenClient.requestAccessToken();
    }

    // Format currency display while storing raw value
    function formatCurrency(input) {
      // Store the raw value in a data attribute
      const rawValue = input.value.replace(/\D/g, '');
      input.dataset.rawValue = rawValue;
      
      // Format display with thousand separators
      if (rawValue.length > 0) {
        input.value = parseInt(rawValue).toLocaleString('id-ID');
      } else {
        input.value = '';
      }
    }

    // Get the raw number value (without formatting)
    function getRawNumber(input) {
      // Get from data attribute if available, otherwise parse from display value
      return input.dataset.rawValue || input.value.replace(/\D/g, '') || '0';
    }

    function showAlert(message, type) {
      const alertDiv = document.createElement('div');
      alertDiv.className = `alert alert-${type}`;
      alertDiv.innerHTML = `
        <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i>
        ${message}
      `;
      
      const container = document.querySelector('.container');
      container.insertBefore(alertDiv, container.firstChild);
      
      setTimeout(() => {
        alertDiv.remove();
      }, 5000);
    }

    function loadSheetData() {
      gapi.client.sheets.spreadsheets.values.get({
        spreadsheetId: SPREADSHEET_ID,
        range: RANGE,
        valueRenderOption: 'UNFORMATTED_VALUE' // Get raw values for numbers
      }).then(response => {
        const data = response.result.values;
        sheetData = data || [];
        
        if (sheetData.length === 0) {
          document.getElementById('content').innerHTML = `
            <div class="alert alert-info">
              <i class="fas fa-info-circle"></i> Tidak ada data ditemukan.
            </div>
          `;
          return;
        }

        // Get headers by reading the first row
        gapi.client.sheets.spreadsheets.values.get({
          spreadsheetId: SPREADSHEET_ID,
          range: `${SHEET_NAME}!A1:H1`
        }).then(headerResponse => {
          const headers = headerResponse.result.values[0];
          
          let html = '<table><thead><tr>';
          headers.forEach(header => {
            html += `<th>${header}</th>`;
          });
          html += '<th>Aksi</th></tr></thead><tbody>';

          sheetData.forEach((row, index) => {
            html += '<tr>';
            row.forEach((cell, colIndex) => {
              // Format khusus untuk kolom tagihan (asumsi kolom ke-4)
              if (colIndex === 4 && cell !== '' && !isNaN(cell)) {
                html += `<td>Rp${parseInt(cell).toLocaleString('id-ID')}</td>`;
              } else {
                html += `<td>${cell || ''}</td>`;
              }
            });
            html += `
              <td class="action-buttons">
                <button class="btn btn-edit" onclick="openEditModal(${index})">
                  <i class="fas fa-edit"></i> Edit
                </button>
                <button class="btn btn-delete" onclick="openDeleteModal(${index})">
                  <i class="fas fa-trash-alt"></i> Hapus
                </button>
              </td>
            </tr>`;
          });

          html += '</tbody></table>';
          document.getElementById('content').innerHTML = html;
        });
      }, error => {
        document.getElementById('content').innerHTML = `
          <div class="alert alert-danger">
            <i class="fas fa-exclamation-triangle"></i> Gagal mengambil data: ${error.result.error.message}
          </div>
        `;
      });
    }

    // Modal functions
    function openEditModal(rowIndex) {
      const rowData = sheetData[rowIndex];
      document.getElementById('edit-row').value = rowIndex + 2; // +2 because sheet starts at row 2 (header is row 1)
      
      document.getElementById('edit-no').value = rowData[0] || '';
      document.getElementById('edit-cust').value = rowData[1] || '';
      document.getElementById('edit-wa').value = rowData[2] || '';
      document.getElementById('edit-alamat').value = rowData[3] || '';
      
      const tagihanInput = document.getElementById('edit-tagihan');
      tagihanInput.value = rowData[4] ? parseInt(rowData[4]).toLocaleString('id-ID') : '';
      tagihanInput.dataset.rawValue = rowData[4] || '';
      
      document.getElementById('edit-tempo').value = rowData[5] || '';
      document.getElementById('edit-ip').value = rowData[6] || '';
      document.getElementById('edit-ket').value = rowData[7] || '';
      
      document.getElementById('editModal').style.display = 'flex';
    }

    function openDeleteModal(rowIndex) {
      document.getElementById('delete-row').value = rowIndex + 2; // +2 because sheet starts at row 2
      document.getElementById('deleteModal').style.display = 'flex';
    }

    function closeModal() {
      document.getElementById('editModal').style.display = 'none';
      document.getElementById('deleteModal').style.display = 'none';
    }

    function confirmDelete() {
      const rowNumber = document.getElementById('delete-row').value;
      
      gapi.client.sheets.spreadsheets.batchUpdate({
        spreadsheetId: SPREADSHEET_ID,
        resource: {
          requests: [{
            deleteDimension: {
              range: {
                sheetId: 0,
                dimension: "ROWS",
                startIndex: rowNumber - 1,
                endIndex: rowNumber
              }
            }
          }]
        }
      }).then(() => {
        showAlert('Data berhasil dihapus!', 'success');
        closeModal();
        loadSheetData();
      }, (error) => {
        showAlert('Gagal menghapus data: ' + error.result.error.message, 'danger');
      });
    }

    // Form submission handlers
    document.getElementById('form-tambah').addEventListener('submit', function(e) {
      e.preventDefault();
      const no = document.getElementById('no').value;
      const cust = document.getElementById('cust').value;
      const wa = document.getElementById('wa').value;
      const alamat = document.getElementById('alamat').value;
      const tagihanInput = document.getElementById('tagihan');
      const tagihan = getRawNumber(tagihanInput);
      const tempo = document.getElementById('tempo').value;
      const ip = document.getElementById('ip').value;
      const ket = document.getElementById('ket').value;

      const values = [[
        no, 
        cust, 
        wa, 
        alamat, 
        parseInt(tagihan), // Submit as raw number
        tempo, 
        ip, 
        ket
      ]];
      
      const body = { values };

      gapi.client.sheets.spreadsheets.values.append({
        spreadsheetId: SPREADSHEET_ID,
        range: `${SHEET_NAME}!A1`,
        valueInputOption: 'USER_ENTERED',
        insertDataOption: 'INSERT_ROWS',
        resource: body
      }).then(() => {
        showAlert('Data berhasil ditambahkan!', 'success');
        loadSheetData();
        document.getElementById('form-tambah').reset();
      }, (error) => {
        showAlert('Gagal menambah data: ' + error.result.error.message, 'danger');
      });
    });

    document.getElementById('form-edit').addEventListener('submit', function(e) {
      e.preventDefault();
      const rowNumber = document.getElementById('edit-row').value;
      const no = document.getElementById('edit-no').value;
      const cust = document.getElementById('edit-cust').value;
      const wa = document.getElementById('edit-wa').value;
      const alamat = document.getElementById('edit-alamat').value;
      const tagihanInput = document.getElementById('edit-tagihan');
      const tagihan = getRawNumber(tagihanInput);
      const tempo = document.getElementById('edit-tempo').value;
      const ip = document.getElementById('edit-ip').value;
      const ket = document.getElementById('edit-ket').value;

      const values = [
        no, 
        cust, 
        wa, 
        alamat, 
        parseInt(tagihan), // Submit as raw number
        tempo, 
        ip, 
        ket
      ];
      
      gapi.client.sheets.spreadsheets.values.update({
        spreadsheetId: SPREADSHEET_ID,
        range: `${SHEET_NAME}!A${rowNumber}:H${rowNumber}`,
        valueInputOption: 'USER_ENTERED',
        resource: {
          values: [values]
        }
      }).then(() => {
        showAlert('Data berhasil diperbarui!', 'success');
        closeModal();
        loadSheetData();
      }, (error) => {
        showAlert('Gagal memperbarui data: ' + error.result.error.message, 'danger');
      });
    });

    // Initialize formatting on page load
    document.addEventListener('DOMContentLoaded', function() {
      const tagihanInput = document.getElementById('tagihan');
      if (tagihanInput.value) {
        formatCurrency(tagihanInput);
      }
    });

    window.onload = handleClientLoad;
  </script>
</body>
</html>

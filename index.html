<!DOCTYPE html>
<html>
<head>
  <title>Dashboard Customer</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://apis.google.com/js/api.js"></script>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <style>
    :root {
      --primary: #4361ee;
      --primary-light: #4895ef;
      --secondary: #3f37c9;
      --dark: #1b263b;
      --light: #f8f9fa;
      --success: #4cc9f0;
      --danger: #f72585;
      --warning: #f8961e;
      --info: #560bad;
      --border-radius: 8px;
      --box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      --transition: all 0.3s ease;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Poppins', sans-serif;
      background-color: #f5f7ff;
      color: var(--dark);
      line-height: 1.6;
      padding: 0;
      margin: 0;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    
    header {
      background-color: white;
      box-shadow: var(--box-shadow);
      padding: 20px 0;
      margin-bottom: 30px;
    }
    
    .header-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    h2 {
      color: var(--primary);
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .btn {
      padding: 10px 20px;
      border-radius: var(--border-radius);
      border: none;
      font-weight: 500;
      cursor: pointer;
      transition: var(--transition);
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    
    .btn-primary {
      background-color: var(--primary);
      color: white;
    }
    
    .btn-primary:hover {
      background-color: var(--secondary);
      transform: translateY(-2px);
    }
    
    .btn-edit {
      background-color: var(--warning);
      color: white;
    }
    
    .btn-delete {
      background-color: var(--danger);
      color: white;
    }
    
    .btn-cancel {
      background-color: #6c757d;
      color: white;
    }
    
    .card {
      background-color: white;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      padding: 25px;
      margin-bottom: 30px;
    }
    
    .card-title {
      font-size: 18px;
      margin-bottom: 20px;
      color: var(--primary);
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    
    th, td {
      padding: 12px 15px;
      text-align: left;
      border-bottom: 1px solid #e0e0e0;
    }
    
    th {
      background-color: var(--primary);
      color: white;
      font-weight: 500;
    }
    
    tr:hover {
      background-color: #f8f9fa;
    }
    
    .action-buttons {
      display: flex;
      gap: 5px;
    }
    
    .form-group {
      margin-bottom: 15px;
    }
    
    .form-row {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 15px;
    }
    
    label {
      display: block;
      margin-bottom: 5px;
      font-weight: 500;
      color: var(--dark);
    }
    
    input, select, textarea {
      width: 100%;
      padding: 10px 15px;
      border: 1px solid #ddd;
      border-radius: var(--border-radius);
      font-family: 'Poppins', sans-serif;
      transition: var(--transition);
    }
    
    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 2px rgba(67, 97, 238, 0.2);
    }
    
    .btn-submit {
      background-color: var(--success);
      color: white;
      padding: 12px 25px;
      margin-top: 10px;
    }
    
    .btn-submit:hover {
      background-color: #3aa8d8;
    }
    
    .alert {
      padding: 15px;
      border-radius: var(--border-radius);
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .alert-success {
      background-color: #d1fae5;
      color: #065f46;
    }
    
    .alert-danger {
      background-color: #fee2e2;
      color: #b91c1c;
    }
    
    .alert-info {
      background-color: #dbeafe;
      color: #1e40af;
    }
    
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }
    
    .modal-content {
      background-color: white;
      padding: 30px;
      border-radius: var(--border-radius);
      width: 90%;
      max-width: 600px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    
    .modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-top: 20px;
    }
    
    .table-responsive {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }
    
    .btn-text {
      display: inline;
    }
    
    /* Responsive Styles */
    @media (max-width: 768px) {
      table {
        display: block;
        overflow-x: auto;
        white-space: nowrap;
      }
      
      .modal-content {
        width: 95%;
        padding: 15px;
      }
      
      .form-row {
        grid-template-columns: 1fr;
      }
      
      .action-buttons {
        flex-direction: column;
        gap: 5px;
      }
      
      .action-buttons .btn {
        width: 100%;
        justify-content: center;
      }
      
      th, td {
        padding: 8px 10px;
        font-size: 14px;
      }
      
      .header-content {
        flex-direction: column;
        gap: 15px;
        align-items: flex-start;
      }
    }
    
    @media (max-width: 600px) {
      .btn-text {
        display: none;
      }
      
      .btn i {
        margin-right: 0;
      }
      
      .form-group {
        margin-bottom: 10px;
      }
      
      .card {
        margin-bottom: 15px;
        padding: 15px;
      }
      
      .btn {
        padding: 8px 12px;
        font-size: 14px;
      }
      
      input, select, textarea {
        padding: 8px 12px;
      }
    }
    
    /* Date input styling */
    input[type="date"] {
      position: relative;
    }
    
    input[type="date"]::-webkit-calendar-picker-indicator {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      width: auto;
      height: auto;
      color: transparent;
      background: transparent;
    }
    
    input[type="date"]::-webkit-inner-spin-button,
    input[type="date"]::-webkit-clear-button {
      display: none;
    }
  </style>
</head>
<body>
  <header>
    <div class="container header-content">
      <h2><i class="fas fa-users"></i> Dashboard Customer</h2>
      <button class="btn btn-primary" onclick="handleAuthClick()">
        <i class="fab fa-google"></i> <span class="btn-text">Login dengan Google</span>
      </button>
    </div>
  </header>

  <main class="container">
    <div class="card">
      <div id="content"></div>
    </div>

    <div class="card">
      <h3 class="card-title"><i class="fas fa-plus-circle"></i> Tambah Data Customer Baru</h3>
      <form id="form-tambah">
        <div class="form-row">
          <div class="form-group">
            <label for="no">No</label>
            <input type="text" id="no" placeholder="No" required>
          </div>
          <div class="form-group">
            <label for="cust">Customer</label>
            <input type="text" id="cust" placeholder="Nama Customer" required>
          </div>
          <div class="form-group">
            <label for="wa">WhatsApp</label>
            <input type="text" id="wa" placeholder="Nomor WhatsApp" required>
          </div>
          <div class="form-group">
            <label for="alamat">Alamat</label>
            <input type="text" id="alamat" placeholder="Alamat" required>
          </div>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label for="tagihan">Tagihan (Rp)</label>
            <input type="text" id="tagihan" placeholder="Contoh: 150000" required 
                   oninput="formatCurrency(this)" pattern="[0-9.,]*">
          </div>
          <div class="form-group">
            <label for="tempo">Jatuh Tempo</label>
            <input type="date" id="tempo" required>
          </div>
          <div class="form-group">
            <label for="ip">IP Internet</label>
            <input type="text" id="ip" placeholder="Alamat IP" required>
          </div>
          <div class="form-group">
            <label for="ket">Keterangan</label>
            <input type="text" id="ket" placeholder="Keterangan tambahan">
          </div>
        </div>
        
        <button type="submit" class="btn btn-submit">
          <i class="fas fa-save"></i> <span class="btn-text">Simpan Data</span>
        </button>
      </form>
    </div>
  </main>

  <!-- Modal Edit -->
  <div id="editModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3><i class="fas fa-edit"></i> Edit Customer</h3>
        <button onclick="closeModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;">&times;</button>
      </div>
      <form id="form-edit">
        <input type="hidden" id="edit-row">
        <div class="form-row">
          <div class="form-group">
            <label for="edit-no">No</label>
            <input type="text" id="edit-no" required>
          </div>
          <div class="form-group">
            <label for="edit-cust">Customer</label>
            <input type="text" id="edit-cust" required>
          </div>
          <div class="form-group">
            <label for="edit-wa">WhatsApp</label>
            <input type="text" id="edit-wa" required>
          </div>
          <div class="form-group">
            <label for="edit-alamat">Alamat</label>
            <input type="text" id="edit-alamat" required>
          </div>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label for="edit-tagihan">Tagihan (Rp)</label>
            <input type="text" id="edit-tagihan" required 
                   oninput="formatCurrency(this)" pattern="[0-9.,]*">
          </div>
          <div class="form-group">
            <label for="edit-tempo">Jatuh Tempo</label>
            <input type="date" id="edit-tempo" required>
          </div>
          <div class="form-group">
            <label for="edit-ip">IP Internet</label>
            <input type="text" id="edit-ip" required>
          </div>
          <div class="form-group">
            <label for="edit-ket">Keterangan</label>
            <input type="text" id="edit-ket">
          </div>
        </div>
        
        <div class="modal-footer">
          <button type="button" class="btn btn-cancel" onclick="closeModal()">
            <i class="fas fa-times"></i> <span class="btn-text">Batal</span>
          </button>
          <button type="submit" class="btn btn-submit">
            <i class="fas fa-save"></i> <span class="btn-text">Simpan Perubahan</span>
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal Delete Confirmation -->
  <div id="deleteModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3><i class="fas fa-trash-alt"></i> Hapus Customer</h3>
        <button onclick="closeModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;">&times;</button>
      </div>
      <p>Apakah Anda yakin ingin menghapus data customer ini?</p>
      <input type="hidden" id="delete-row">
      <div class="modal-footer">
        <button type="button" class="btn btn-cancel" onclick="closeModal()">
          <i class="fas fa-times"></i> <span class="btn-text">Batal</span>
        </button>
        <button type="button" class="btn btn-delete" onclick="confirmDelete()">
          <i class="fas fa-trash-alt"></i> <span class="btn-text">Hapus</span>
        </button>
      </div>
    </div>
  </div>

  <script>
    const CLIENT_ID = '805721921065-idl1i4jonepi7odtr4f7eiv1h4mbamk2.apps.googleusercontent.com';
    const API_KEY = 'AIzaSyArISbb4W_mfRyZxJzi12Sm3eByi0jQCjM';
    const SPREADSHEET_ID = '1AQx4YgRW9R-epO8BGlyFvN7CKIGyKgxmE1LgGqNpbs4';
    const SHEET_NAME = 'DATA CUSTOMER';
    const RANGE = `${SHEET_NAME}!A2:H`;
    const SCOPES = 'https://www.googleapis.com/auth/spreadsheets';

    let tokenClient;
    let sheetData = [];

    function handleClientLoad() {
      gapi.load('client', initClient);
    }

    async function initClient() {
      await gapi.client.init({
        apiKey: API_KEY,
        discoveryDocs: ["https://sheets.googleapis.com/$discovery/rest?version=v4"]
      });

      tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: CLIENT_ID,
        scope: SCOPES,
        callback: (tokenResponse) => {
          if (tokenResponse.error) {
            showAlert('Login gagal', 'danger');
            return;
          }
          loadSheetData();
        },
      });
    }

    function handleAuthClick() {
      tokenClient.requestAccessToken();
    }

    // Format currency display while storing raw value
    function formatCurrency(input) {
      // Store the raw value in a data attribute
      const rawValue = input.value.replace(/\D/g, '');
      input.dataset.rawValue = rawValue;
      
      // Format display with thousand separators
      if (rawValue.length > 0) {
        input.value = parseInt(rawValue).toLocaleString('id-ID');
      } else {
        input.value = '';
      }
    }

    // Get the raw number value (without formatting)
    function getRawNumber(input) {
      // Get from data attribute if available, otherwise parse from display value
      return input.dataset.rawValue || input.value.replace(/\D/g, '') || '0';
    }

    function showAlert(message, type) {
      const alertDiv = document.createElement('div');
      alertDiv.className = `alert alert-${type}`;
      alertDiv.innerHTML = `
        <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i>
        ${message}
      `;
      
      const container = document.querySelector('.container');
      container.insertBefore(alertDiv, container.firstChild);
      
      setTimeout(() => {
        alertDiv.remove();
      }, 5000);
    }

    function excelDateToJSDate(serial) {
      const utcDays = Math.floor(serial - 25569);
      const utcValue = utcDays * 86400;
      const date = new Date(utcValue * 1000);
      
      // Handle Excel's leap year bug (1900 is not a leap year)
      if (serial < 60) {
        date.setFullYear(date.getFullYear() - 1);
      }
      
      return date;
    }

    // Ganti fungsi loadSheetData dengan ini:
function loadSheetData() {
  gapi.client.sheets.spreadsheets.values.get({
    spreadsheetId: SPREADSHEET_ID,
    range: RANGE,
    valueRenderOption: 'UNFORMATTED_VALUE',
    dateTimeRenderOption: 'FORMATTED_STRING' // Tambahkan ini
  }).then(response => {
    const data = response.result.values;
    sheetData = data || [];
    
    if (!sheetData || sheetData.length === 0) {
      document.getElementById('content').innerHTML = `
        <div class="alert alert-info">
          <i class="fas fa-info-circle"></i> Tidak ada data ditemukan.
        </div>
      `;
      return;
    }

// Urutkan data berdasarkan tanggal di kolom ke-6 (index 5)
sheetData.sort((a, b) => {
  const dateA = new Date(a[5]);
  const dateB = new Date(b[5]);
  return dateA - dateB; // naik, gunakan dateB - dateA untuk menurun
});
    // Get headers
    gapi.client.sheets.spreadsheets.values.get({
      spreadsheetId: SPREADSHEET_ID,
      range: `${SHEET_NAME}!A1:H1`,
      valueRenderOption: 'FORMATTED_VALUE'
    }).then(headerResponse => {
      const headers = headerResponse.result.values ? headerResponse.result.values[0] : [];
      
      let html = '<div class="table-responsive"><table><thead><tr>';
      headers.forEach(header => {
        html += `<th>${header || ''}</th>`;
      });
      html += '<th>Aksi</th></tr></thead><tbody>';

      sheetData.forEach((row, index) => {
        if (!row) return;
        
        html += '<tr>';
        // Pastikan selalu ada 8 kolom
        const rowData = [...row];
        while (rowData.length < 8) rowData.push('');
        
        rowData.forEach((cell, colIndex) => {
          // Kolom tagihan (index 4)
          if (colIndex === 4 && cell !== '' && !isNaN(cell)) {
            html += `<td>Rp${parseInt(cell).toLocaleString('id-ID')}</td>`;
          } 
          // Kolom tanggal (index 5)
          else if (colIndex === 5) {
            // Jika sudah format string (FORMATTED_STRING)
            if (typeof cell === 'string') {
              html += `<td>${cell || ''}</td>`;
            } 
            // Jika serial number Excel
            else if (!isNaN(cell)) {
              const date = new Date((cell - 25568) * 86400 * 1000);
              const formattedDate = date.toISOString().split('T')[0];
              html += `<td>${formattedDate}</td>`;
            } else {
              html += `<td>${cell || ''}</td>`;
            }
          }
          else {
            html += `<td>${cell || ''}</td>`;
          }
        });
        
        html += `
          <td class="action-buttons">
            <button class="btn btn-edit" onclick="openEditModal(${index})">
              <i class="fas fa-edit"></i> <span class="btn-text">Edit</span>
            </button>
            <button class="btn btn-delete" onclick="openDeleteModal(${index})">
              <i class="fas fa-trash-alt"></i> <span class="btn-text">Hapus</span>
            </button>
          </td>
        </tr>`;
      });

      html += '</tbody></table></div>';
      document.getElementById('content').innerHTML = html;
      
    }).catch(error => {
      console.error('Error loading headers:', error);
      showAlert('Gagal memuat header data', 'danger');
    });
    
  }).catch(error => {
    console.error('Error loading data:', error);
    document.getElementById('content').innerHTML = `
      <div class="alert alert-danger">
        <i class="fas fa-exclamation-triangle"></i> Gagal mengambil data: ${error.result?.error?.message || 'Error tidak diketahui'}
      </div>
    `;
  });
}

// Ganti fungsi excelDateToJSDate dengan ini:
function excelDateToJSDate(serial) {
  try {
    // Jika sudah berupa string tanggal, langsung kembalikan
    if (typeof serial === 'string') return new Date(serial);
    
    // Konversi dari serial Excel
    const utcDays = Math.floor(serial - 25568); // 25568 = days between 1900-01-01 and 1970-01-01
    const utcValue = utcDays * 86400; // 86400 = seconds per day
    const date = new Date(utcValue * 1000);
    
    // Handle Excel leap year bug (1900 bukan kabisat)
    if (serial < 60) {
      date.setFullYear(date.getFullYear() - 1);
    }
    
    return date;
  } catch (e) {
    console.error('Error converting Excel date:', serial, e);
    return new Date(); // Kembalikan tanggal sekarang jika error
  }
}

    // Modal functions
    function openEditModal(rowIndex) {
      const rowData = sheetData[rowIndex];
      document.getElementById('edit-row').value = rowIndex + 2; // +2 because sheet starts at row 2 (header is row 1)
      
      document.getElementById('edit-no').value = rowData[0] || '';
      document.getElementById('edit-cust').value = rowData[1] || '';
      document.getElementById('edit-wa').value = rowData[2] || '';
      document.getElementById('edit-alamat').value = rowData[3] || '';
      
      const tagihanInput = document.getElementById('edit-tagihan');
      tagihanInput.value = rowData[4] ? parseInt(rowData[4]).toLocaleString('id-ID') : '';
      tagihanInput.dataset.rawValue = rowData[4] || '';
      
      // Handle date conversion for edit form
      const tempoInput = document.getElementById('edit-tempo');
      if (rowData[5]) {
        const date = excelDateToJSDate(rowData[5]);
        tempoInput.value = date.toISOString().split('T')[0];
      } else {
        tempoInput.value = '';
      }
      
      document.getElementById('edit-ip').value = rowData[6] || '';
      document.getElementById('edit-ket').value = rowData[7] || '';
      
      document.getElementById('editModal').style.display = 'flex';
    }

    function openDeleteModal(rowIndex) {
      document.getElementById('delete-row').value = rowIndex + 2; // +2 because sheet starts at row 2
      document.getElementById('deleteModal').style.display = 'flex';
    }

    function closeModal() {
      document.getElementById('editModal').style.display = 'none';
      document.getElementById('deleteModal').style.display = 'none';
    }

    function confirmDelete() {
      const rowNumber = document.getElementById('delete-row').value;
      
      gapi.client.sheets.spreadsheets.batchUpdate({
        spreadsheetId: SPREADSHEET_ID,
        resource: {
          requests: [{
            deleteDimension: {
              range: {
                sheetId: 0,
                dimension: "ROWS",
                startIndex: rowNumber - 1,
                endIndex: rowNumber
              }
            }
          }]
        }
      }).then(() => {
        showAlert('Data berhasil dihapus!', 'success');
        closeModal();
        loadSheetData();
      }, (error) => {
        showAlert('Gagal menghapus data: ' + error.result.error.message, 'danger');
      });
    }

    // Form submission handlers
    document.getElementById('form-tambah').addEventListener('submit', function(e) {
      e.preventDefault();
      const no = document.getElementById('no').value;
      const cust = document.getElementById('cust').value;
      const wa = document.getElementById('wa').value;
      const alamat = document.getElementById('alamat').value;
      const tagihanInput = document.getElementById('tagihan');
      const tagihan = getRawNumber(tagihanInput);
      const tempo = document.getElementById('tempo').value;
      const ip = document.getElementById('ip').value;
      const ket = document.getElementById('ket').value;

      const values = [[
        no, 
        cust, 
        wa, 
        alamat, 
        parseInt(tagihan), // Submit as raw number
        tempo, 
        ip, 
        ket
      ]];
      
      const body = { values };

      gapi.client.sheets.spreadsheets.values.append({
        spreadsheetId: SPREADSHEET_ID,
        range: `${SHEET_NAME}!A1`,
        valueInputOption: 'USER_ENTERED',
        insertDataOption: 'INSERT_ROWS',
        resource: body
      }).then(() => {
        showAlert('Data berhasil ditambahkan!', 'success');
        loadSheetData();
        document.getElementById('form-tambah').reset();
      }, (error) => {
        showAlert('Gagal menambah data: ' + error.result.error.message, 'danger');
      });
    });

    document.getElementById('form-edit').addEventListener('submit', function(e) {
      e.preventDefault();
      const rowNumber = document.getElementById('edit-row').value;
      const no = document.getElementById('edit-no').value;
      const cust = document.getElementById('edit-cust').value;
      const wa = document.getElementById('edit-wa').value;
      const alamat = document.getElementById('edit-alamat').value;
      const tagihanInput = document.getElementById('edit-tagihan');
      const tagihan = getRawNumber(tagihanInput);
      const tempo = document.getElementById('edit-tempo').value;
      const ip = document.getElementById('edit-ip').value;
      const ket = document.getElementById('edit-ket').value;

      const values = [
        no, 
        cust, 
        wa, 
        alamat, 
        parseInt(tagihan), // Submit as raw number
        tempo, 
        ip, 
        ket
      ];
      
      gapi.client.sheets.spreadsheets.values.update({
        spreadsheetId: SPREADSHEET_ID,
        range: `${SHEET_NAME}!A${rowNumber}:H${rowNumber}`,
        valueInputOption: 'USER_ENTERED',
        resource: {
          values: [values]
        }
      }).then(() => {
        showAlert('Data berhasil diperbarui!', 'success');
        closeModal();
        loadSheetData();
      }, (error) => {
        showAlert('Gagal memperbarui data: ' + error.result.error.message, 'danger');
      });
    });

    // Initialize formatting on page load
    document.addEventListener('DOMContentLoaded', function() {
      const tagihanInput = document.getElementById('tagihan');
      if (tagihanInput.value) {
        formatCurrency(tagihanInput);
      }
    });

    window.onload = handleClientLoad;
  </script>
</body>
</html>
